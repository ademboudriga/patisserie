<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Commandes - P√¢tisserie Sucr√©e</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="flex h-screen bg-gradient-to-br from-rose-50 via-pink-50 to-white">

  <!-- üå∏ Sidebar -->
  <aside class="w-64 bg-gradient-to-br from-pink-500 to-rose-500 text-white flex flex-col shadow-xl">
    <div class="p-6 flex-1">
      <h2 class="text-3xl font-extrabold mb-10 tracking-wide">üç∞ P√¢tisserie</h2>
      <nav class="flex flex-col space-y-2">
        <a href="dashboard.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10"><i class="fas fa-box"></i> Mati√®res Premi√®res</a>
        <a href="consommation.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10"><i class="fas fa-chart-line"></i> Consommations</a>
        <a href="produit.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10"><i class="fas fa-birthday-cake"></i> Produits</a>
        <a href="vente.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10"><i class="fas fa-cash-register"></i> Ventes</a>
        <a href="commandes.html" class="flex items-center gap-3 p-3 rounded-lg bg-white/10"><i class="fas fa-receipt"></i> Commandes</a>
        <a href="modifierProfile.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10"><i class="fas fa-user-edit"></i> Modifier Profil</a>
        <a href="index.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10"><i class="fas fa-sign-out-alt"></i> D√©connexion</a>
      </nav>
    </div>
  </aside>

  <!-- üå∑ Contenu principal -->
  <main class="flex-1 p-8 overflow-auto">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
      <h1 class="text-3xl font-extrabold text-gray-800">üìã Gestion des Commandes</h1>
      <div class="flex gap-2 flex-wrap">
        <input type="text" id="searchInput" placeholder="Rechercher par nom/pr√©nom" class="px-3 py-2 border rounded-lg outline-none" />
        <button id="btnAddCommande" class="bg-pink-500 hover:bg-pink-600 text-white px-5 py-2.5 rounded-lg shadow-md flex items-center gap-2 transition transform hover:scale-105">
          <i class="fas fa-plus"></i> Ajouter
        </button>
      </div>
    </div>

    <!-- üßÅ Tableau commandes -->
    <section class="bg-white/70 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-pink-100">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Liste des Commandes</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-pink-100/50 text-gray-700">
              <th class="p-3 text-center">Client</th>
              <th class="p-3 text-center">T√©l√©phone</th>
              <th class="p-3 text-center">Dimensions</th>
              <th class="p-3 text-center">√âtages</th>
              <th class="p-3 text-center">Prix</th>
              <th class="p-3 text-center">Accompte</th>
              <th class="p-3 text-center">Statut</th>
              <th class="p-3 text-center">Livraison</th>
              <th class="p-3 text-center">Cr√©√©e le</th>
              <th class="p-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="commandeTableBody">
            <tr><td colspan="10" class="p-4 text-center text-gray-500">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex justify-center gap-4 mt-4">
        <button id="prevPage" class="px-3 py-1 border rounded-lg hover:bg-gray-100">Pr√©c√©dent</button>
        <span id="pageInfo" class="px-2 py-1 text-gray-700"></span>
        <button id="nextPage" class="px-3 py-1 border rounded-lg hover:bg-gray-100">Suivant</button>
      </div>
    </section>
  </main>

  <!-- üå∏ Modal Commande -->
  <div id="modalCommande" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 animate-fadeIn">
      <h2 id="modalTitle" class="text-2xl font-bold text-center text-gray-800 mb-6">‚ûï Ajouter une commande</h2>
      <form id="commandeForm" class="space-y-4" data-id="">
        <div class="grid grid-cols-2 gap-3">
          <input type="text" name="nom_client" required placeholder="Nom du client" class="input-style" />
          <input type="text" name="prenom_client" required placeholder="Pr√©nom du client" class="input-style" />
        </div>

        <input type="tel" name="telephone" required placeholder="T√©l√©phone" class="input-style" />

        <div class="grid grid-cols-2 gap-3">
          <input type="number" name="longueur" required min="1" step="0.5" placeholder="Longueur (cm)" class="input-style" />
          <input type="number" name="largeur" required min="1" step="0.5" placeholder="Largeur (cm)" class="input-style" />
        </div>

        <input type="number" name="nombre_etages" min="1" placeholder="Nombre d'√©tages" class="input-style" />

        <div class="grid grid-cols-2 gap-3">
          <input type="number" name="prix" required min="0" step="0.5" placeholder="Prix (DT)" class="input-style" />
          <input type="number" name="accompte" min="0" step="0.5" placeholder="Accompte (DT)" class="input-style" />
        </div>

        <input type="date" name="date_livraison" required class="input-style" />
        <textarea name="description" rows="3" placeholder="Description..." class="input-style"></textarea>

        <select name="statut" class="input-style">
          <option value="en attente">En Attente</option>
          <option value="livr√©e">Livr√©e</option>
        </select>

        <div class="flex justify-end gap-3 mt-6">
          <button type="button" id="closeModal" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition">Annuler</button>
          <button type="submit" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 shadow-md transition">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = '/api/commandes';
    const tableBody = document.getElementById('commandeTableBody');
    const modal = document.getElementById('modalCommande');
    const btnAddCommande = document.getElementById('btnAddCommande');
    const closeModal = document.getElementById('closeModal');
    const form = document.getElementById('commandeForm');
    const modalTitle = document.getElementById('modalTitle');
    const searchInput = document.getElementById('searchInput');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');

    let currentPage = 1;
    let totalPages = 1;
    const limit = 10;
    let searchQuery = '';

    btnAddCommande.addEventListener('click', () => {
      form.reset();
      form.dataset.id = '';
      modalTitle.textContent = '‚ûï Ajouter une commande';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    closeModal.addEventListener('click', () => modal.classList.add('hidden'));
    window.addEventListener('click', e => { if (e.target === modal) modal.classList.add('hidden'); });

    searchInput.addEventListener('input', () => {
      searchQuery = searchInput.value;
      currentPage = 1;
      fetchCommandes();
    });

    prevPage.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        fetchCommandes();
      }
    });

    nextPage.addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        fetchCommandes();
      }
    });

    async function fetchCommandes() {
      tableBody.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-gray-500">Chargement...</td></tr>`;
      try {
        const res = await fetch(`${API_URL}?search=${encodeURIComponent(searchQuery)}&page=${currentPage}&limit=${limit}`);
        const data = await res.json();
        const commandes = data.commandes || [];
        const totalItems = data.total || commandes.length;
        totalPages = Math.max(1, Math.ceil(totalItems / limit));

        pageInfo.textContent = `Page ${currentPage} / ${totalPages}`;
        prevPage.disabled = currentPage === 1;
        nextPage.disabled = currentPage === totalPages;

        renderTable(commandes);
      } catch (err) {
        console.error(err);
        tableBody.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-red-500">Erreur de chargement</td></tr>`;
      }
    }

    function renderTable(commandes) {
      if (!commandes.length) {
        tableBody.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-gray-500">Aucune commande</td></tr>`;
        return;
      }
      tableBody.innerHTML = commandes.map(c => `
        <tr class="hover:bg-pink-50 border-b transition">
          <td class="p-3 text-center">${c.nom_client} ${c.prenom_client}</td>
          <td class="p-3 text-center">${c.telephone}</td>
          <td class="p-3 text-center">${c.longueur}x${c.largeur} cm</td>
          <td class="p-3 text-center">${c.nombre_etages}</td>
          <td class="p-3 text-center font-semibold">${c.prix.toFixed(2)} DT</td>
          <td class="p-3 text-center">${c.accompte.toFixed(2)} DT</td>
          <td class="p-3 text-center">
            <span class="px-2 py-1 rounded-full text-xs font-semibold ${
              c.statut === 'livr√©e' ? 'bg-blue-200 text-blue-800' : 'bg-yellow-200 text-yellow-800'
            }">${c.statut}</span>
          </td>
          <td class="p-3 text-center">${new Date(c.date_livraison).toLocaleDateString()}</td>
          <td class="p-3 text-center">${new Date(c.date_creation).toLocaleDateString()}</td>
          <td class="p-3 text-center flex justify-center gap-2">
            <button class="text-blue-500 hover:text-blue-700" onclick="editCommande(${c.id})"><i class="fas fa-edit"></i></button>
            <button class="text-red-500 hover:text-red-700" onclick="deleteCommande(${c.id})"><i class="fas fa-trash"></i></button>
 
            <a href="/html/r√©cu.html?nom_client=${encodeURIComponent(c.nom_client)}&prenom_client=${encodeURIComponent(c.prenom_client)}&telephone=${encodeURIComponent(c.telephone)}&longueur=${c.longueur}&largeur=${c.largeur}&nombre_etages=${c.nombre_etages}&prix=${c.prix}&accompte=${c.accompte}&date_livraison=${c.date_livraison}&description=${encodeURIComponent(c.description)}&statut=${encodeURIComponent(c.statut)}"" target="_blank" class="text-green-500 hover:text-green-700" title="Voir Re√ßu">
              <i class="fas fa-receipt"></i>
            </a>

          </td>
        </tr>
      `).join('');
    }

    // üîπ CRUD
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(form));
      formData.longueur = parseFloat(formData.longueur);
      formData.largeur = parseFloat(formData.largeur);
      formData.nombre_etages = parseInt(formData.nombre_etages);
      formData.prix = parseFloat(formData.prix);
      formData.accompte = parseFloat(formData.accompte);

      const method = form.dataset.id ? 'PUT' : 'POST';
      const url = form.dataset.id ? `${API_URL}/${form.dataset.id}` : API_URL;

      await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      modal.classList.add('hidden');
      fetchCommandes();
    });

    window.editCommande = async id => {
      const res = await fetch(`${API_URL}/${id}`);
      const c = await res.json();
      form.nom_client.value = c.nom_client
      form.prenom_client.value = c.prenom_client;
      form.telephone.value = c.telephone;
      form.longueur.value = c.longueur;
      form.largeur.value = c.largeur;
      form.nombre_etages.value = c.nombre_etages;
      form.prix.value = c.prix;
      form.accompte.value = c.accompte;
      form.date_livraison.value = c.date_livraison.split('T')[0]; // format YYYY-MM-DD
      form.description.value = c.description;
      form.statut.value = c.statut;
      form.dataset.id = c.id;
      modalTitle.textContent = '‚úèÔ∏è Modifier la commande';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };

    window.deleteCommande = async id => {
      if (confirm('Voulez-vous vraiment supprimer cette commande ?')) {
        try {
          await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
          fetchCommandes();
        } catch (err) {
          console.error(err);
          alert('Erreur lors de la suppression.');
        }
      }
    };

    // Initial load
    fetchCommandes();
  </script>

  <style>
    .input-style {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      outline: none;
      transition: all 0.2s;
    }
    .input-style:focus {
      border-color: #f472b6; /* pink-400 */
      box-shadow: 0 0 0 2px rgba(244, 114, 182, 0.2);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
  </style>

</body>
</html>
